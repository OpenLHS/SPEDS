<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExchangeDataReply.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">speds-transport-library</a> &gt; <a href="index.source.html" class="el_package">ca.griis.speds.transport.service.server</a> &gt; <span class="el_source">ExchangeDataReply.java</span></div><h1>ExchangeDataReply.java</h1><pre class="source lang-java linenums">/**
 * @file
 *
 * @copyright @@GRIIS_COPYRIGHT@@
 *
 * @licence @@GRIIS_LICENCE@@
 *
 * @version @@GRIIS_VERSION@@
 *
 * @brief @~french Implémentation de la classe ExchangeDataIndication.
 * @brief @~english Implementation of the ExchangeDataIndication class.
 */

package ca.griis.speds.transport.service.server;

import ca.griis.cryptography.hash.entity.Hash;
import ca.griis.cryptography.hash.hashing.Sha512Hashing;
import ca.griis.js2p.gen.speds.transport.api.dto.Context34Dto;
import ca.griis.js2p.gen.speds.transport.api.dto.Context45Dto;
import ca.griis.js2p.gen.speds.transport.api.dto.Header45Dto;
import ca.griis.js2p.gen.speds.transport.api.dto.InterfaceDataUnit34Dto;
import ca.griis.js2p.gen.speds.transport.api.dto.InterfaceDataUnit45Dto;
import ca.griis.js2p.gen.speds.transport.api.dto.ProtocolDataUnit4TraDto;
import ca.griis.js2p.gen.speds.transport.api.dto.Speds45Dto;
import ca.griis.js2p.gen.speds.transport.api.dto.StampDto;
import ca.griis.logger.GriisLogger;
import ca.griis.logger.GriisLoggerFactory;
import ca.griis.logger.statuscode.Trace;
import ca.griis.speds.transport.serializer.SharedObjectMapper;
import ca.griis.speds.transport.service.DataReplyMessages;
import ca.griis.speds.transport.service.SilentIgnoredException;
import ca.griis.speds.transport.service.security.StampVerifier;
import com.fasterxml.jackson.core.JsonProcessingException;
import java.nio.charset.StandardCharsets;
import java.util.UUID;

/**
 * @brief @~english «Brief component description (class, interface, ...)»
 * @par Details
 *      «Detailed description of the component (optional)»
 * @par Model
 *      «Model (Abstract, automation, etc.) (optional)»
 * @par Conception
 *      «Conception description (criteria and constraints) (optional)»
 * @par Limits
 *      «Limits description (optional)»
 *
 * @brief @~french Un processus qui reçoit une indication d'échange de données.
 * @par Details
 *      S.O.
 * @par Modèle
 *      S.O.
 * @par Conception
 *      S.O.
 * @par Limites
 *      S.O.
 *
 * @par Historique
 *      2025-03-11 [JM] - Première ébauche.
 *
 * @par Tâches
 *      S.O.
 */
public final class ExchangeDataReply {
<span class="fc" id="L65">  private static final GriisLogger logger = GriisLoggerFactory.getLogger(ExchangeDataReply.class);</span>

  private final StampVerifier stampVerfier;

<span class="fc" id="L69">  public ExchangeDataReply() {</span>
<span class="fc" id="L70">    logger.trace(Trace.ENTER_METHOD_0);</span>

<span class="fc" id="L72">    this.stampVerfier = new StampVerifier();</span>
<span class="fc" id="L73">  }</span>

  /**
   * @brief @~english «Description of the function»
   * @param «parameter name» «Parameter description»
   * @exception «exception name» «Exception description»
   * @return «Return description»
   *
   * @brief @~french Traite la réception d'un message requête de la couche transport.
   * @param iduDto IDU de la couche inférieure.
   * @exception SilentIgnoredException Exception silencieuse.
   * @return Un IDU à la couche supérieure et un à la couche inférieure.
   *
   * @par Tâches
   *      S.O.
   */
  public DataReplyMessages indication(InterfaceDataUnit45Dto iduDto) {
<span class="fc" id="L90">    logger.trace(Trace.ENTER_METHOD_1, &quot;iduDto&quot;, iduDto);</span>

    // Récupérer SDU
    final ProtocolDataUnit4TraDto pdu;
    try {
<span class="fc" id="L95">      pdu = SharedObjectMapper.getInstance().getMapper().readValue(iduDto.getMessage(),</span>
          ProtocolDataUnit4TraDto.class);
<span class="nc" id="L97">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L98">      throw new SilentIgnoredException(e.getMessage());</span>
<span class="fc" id="L99">    }</span>

    // Création du ICI du Idu3-4
    // extraire le code des iri
<span class="fc" id="L103">    final String sourceIri = iduDto.getContext().getSourceIri();</span>
<span class="fc" id="L104">    final String destinationIri = iduDto.getContext().getDestinationIri();</span>
<span class="fc" id="L105">    final String sourceCode = pdu.getHeader().getSourceCode();</span>
<span class="fc" id="L106">    final String destinationCode = pdu.getHeader().getDestinationCode();</span>

<span class="fc" id="L108">    final Sha512Hashing sha512Hashing = new Sha512Hashing();</span>
<span class="fc" id="L109">    stampVerfier.verifyStamps(pdu, sha512Hashing);</span>

    // Création du message ACK à envoyé à la couche inférieure
<span class="fc" id="L112">    final String msgId = (String) pdu.getHeader().getId();</span>
<span class="fc" id="L113">    final Header45Dto headerTraDto =</span>
        new Header45Dto(Header45Dto.Msgtype.TRA_MSG_REC, msgId, sourceCode, destinationCode,
<span class="fc" id="L115">            new Speds45Dto(pdu.getHeader().getSpeds().getVersion(),</span>
<span class="fc" id="L116">                pdu.getHeader().getSpeds().getReference()));</span>
<span class="fc" id="L117">    final String contentResponse = &quot;ACK&quot;;</span>

    // Créer le sceau de l'entête et du contenu
    final String headerString;
    try {
<span class="fc" id="L122">      headerString = SharedObjectMapper.getInstance().getMapper().writeValueAsString(headerTraDto);</span>
<span class="nc" id="L123">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L124">      throw new SilentIgnoredException(e.getMessage());</span>
<span class="fc" id="L125">    }</span>

<span class="fc" id="L127">    final Hash hashHeader = sha512Hashing.hash(headerString.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L128">    final Hash hashContent = sha512Hashing.hash(contentResponse.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L129">    final String sealHeaderSdu = hashHeader.asBase64();</span>
<span class="fc" id="L130">    final String sealContentSdu = hashContent.asBase64();</span>

<span class="fc" id="L132">    final StampDto stampTra = new StampDto(sealHeaderSdu, sealContentSdu);</span>

<span class="fc" id="L134">    final ProtocolDataUnit4TraDto pduTraResponse =</span>
        new ProtocolDataUnit4TraDto(headerTraDto, stampTra, contentResponse);

    // Sérialiser le message protocole de Transport
<span class="fc" id="L138">    final Context45Dto iduContext45 = new Context45Dto(destinationIri, sourceIri,</span>
<span class="fc" id="L139">        iduDto.getContext().getTrackingNumber(), iduDto.getContext().getOptions());</span>
    final String serializedTraMessage;
    final String idu45Response;
    try {
      serializedTraMessage =
<span class="fc" id="L144">          SharedObjectMapper.getInstance().getMapper().writeValueAsString(pduTraResponse);</span>
<span class="fc" id="L145">      final InterfaceDataUnit45Dto idu45 =</span>
          new InterfaceDataUnit45Dto(iduContext45, serializedTraMessage);
<span class="fc" id="L147">      idu45Response = SharedObjectMapper.getInstance().getMapper().writeValueAsString(idu45);</span>
<span class="nc" id="L148">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L149">      throw new SilentIgnoredException(e.getMessage());</span>
<span class="fc" id="L150">    }</span>

    // Création du tracking number en utilisant le msgId de Transport
<span class="fc" id="L153">    final UUID trackingNumber = UUID.fromString(msgId);</span>

<span class="fc" id="L155">    final Context34Dto context34Dto = new Context34Dto(</span>
        sourceCode,
        destinationCode,
        sourceIri,
        trackingNumber,
        destinationIri,
        Boolean.FALSE);

    // Création du message à envoyer à la couche supérieur
<span class="fc" id="L164">    final InterfaceDataUnit34Dto idu34 = new InterfaceDataUnit34Dto(context34Dto, pdu.getContent());</span>

    final String idu34Indication;
    try {
<span class="fc" id="L168">      idu34Indication = SharedObjectMapper.getInstance().getMapper().writeValueAsString(idu34);</span>
<span class="nc" id="L169">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L170">      throw new SilentIgnoredException(e.getMessage());</span>
<span class="fc" id="L171">    }</span>

<span class="fc" id="L173">    final DataReplyMessages dataReplyMessages = new DataReplyMessages(idu34Indication,</span>
        idu45Response);

<span class="fc" id="L176">    logger.trace(Trace.EXIT_METHOD_1, &quot;dataReplyMessages&quot;, dataReplyMessages);</span>
<span class="fc" id="L177">    return dataReplyMessages;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>